<dataConfig>
    <dataSource type="JdbcDataSource" driver="org.postgresql.Driver" url="jdbc:postgresql://localhost:5432/defaultdb" user="zimmerman" password="" />
    <document>
        <entity name="organisation"
            pk="iati_identifier" 
            query="
                SELECT
                    id,
                    organisation_identifier, 
                    primary_name, 
                    type_id,
                    reported_in_iati, 
                    published,
                    last_updated_datetime, 
                    default_currency_id,
                    default_lang_id
                FROM iati_organisation_organisation
            "
        >  
            <field column="organisation_identifier" name="id"/>
            <field column="organisation_identifier" name="organisation_identifier"/>
            <field column="type_id" name="organisation_type"/>
            <field column="reported_in_iati" name="organisation_reported_in_iati"/>
            <field column="published" name="organisation_published"/>
            <field column="last_updated_datetime" name="organisation_last_updated_datetime"/>
            <field column="default_currency_id" name="organisation_default_currency_code"/>
            <field column="default_lang_id" name="organisation_default_lang_code"/>
            <entity name="organisation_name"
                query="
                     SELECT
                        id,
                        CAST((
                            SELECT
                                JSON_AGG(ROW_TO_JSON(name_record)) AS name
                            FROM (
                                SELECT
                                       language_id AS lang,
                                       content AS narrative
                                FROM iati_organisation_organisationnarrative, django_content_type
                                WHERE object_id=iati_organisation_organisationname.id
                                    AND django_content_type.model='organisationname'
                                    AND content_type_id=django_content_type.id
                                ) as name_record
                        ) AS VARCHAR)
                    FROM iati_organisation_organisationname
                    WHERE iati_organisation_organisationname.organisation_id=${organiation.id}
                "
            >
                <field column="name" name="organisation_name"/>
                <entity name="organisation_name_narrative"
                    query="
                        SELECT
                            iati_organisation_organisationnarrative.content AS content
                        FROM iati_organisation_organisationnarrative, django_content_type
                        WHERE iati_organisation_organisationnarrative.object_id=${organisation_name.id}
                            AND iati_organisation_organisationnarrative.organisation_id=${organisation.id}
                            AND django_content_type.model='organisationname'
                            AND django_content_type.id=iati_organisation_organisationnarrative.content_type_id
                    "
                >
                    <field column="content" name="organisation_name_narrative"/>
                </entity>
            </entity>
        </entity>                         
    </document>
</dataConfig>